# シャドウイング練習アプリ・詳細統合仕様書

## 1. アプリ概要

### 1.1 目的

日本人の英語学習者向けに、シャドウイング（音声を聞きながら同時に発音する練習法）と音読練習を通じて、英語の発音を改善するiOSアプリ。さらに、「自分で録音した教材」を使って練習できる柔軟性を提供する。

### 1.2 ターゲットユーザー

- 日本人の英語学習者
- 英語の発音を改善したい人
- TOEICやビジネス英語の発音練習をしたい人
- 自分で録音した映画やニュースのワンシーンなどを教材にしたい人
- シャドウィングが正義であると信じている人
- プルリクエストの意味がわかっていない人

### 1.3 主要機能

1. **教材作成機能**\
   　a. 音声ファイル取り込み（mp3/wavなど）\
   　b. その場で教材音声を録音して追加
2. **音声認識機能**：教材・練習音声ともに文字起こし（英語のみ）
3. **練習モード**：音読練習とシャドウィング練習
4. **評価機能**：発音の正確性を評価し、フィードバックを提供
5. **Diff（差分）表示機能**：ユーザー発話と教材テキストの差異を視覚的に表示

---

## 2. 技術仕様

- IDE: Xcode 16.3
- 言語: Swift 5.0
- 最小iOS: iOS 18.4
- UI Framework: SwiftUI
- アーキテクチャ: MVVM風
- AVFoundation, Speech Framework, Combine
- Diff表示はPythonサーバーで生成する場合、API連携を想定

---

## 3. 機能詳細

### 3.1 教材作成機能

- 音声ファイルインポート（mp3, wav, m4a形式。最大10分/100MBまで）
- その場で教材録音（最大2分、録音後に内容確認・再録音も可能）
- 教材リストにタイトルやメモを追加・編集

### 3.2 音声録音機能（練習用）

- 練習（音読・シャドウィング）時にユーザー発音を録音
- 録音中は経過時間表示
- 録音後は自動で文字起こし＆評価

### 3.3 音声認識機能

- 教材音声/練習音声ともに英語音声を文字起こし（Speech Framework）
- ファイルベース認識。認識進捗をパーセンテージで表示

### 3.4 練習モード

- 音読モード：教材テキストを表示、ユーザーが音読して録音、評価
- シャドウィングモード：教材音声を再生、同時にユーザーが発音し録音、評価（再生はリピート・速度変更可）
- 練習モード選択→教材選択→テキスト・音声再生→録音→評価→結果表示

### 3.5 評価機能

- Levenshtein距離による単語比較
- Word Error Rate (WER) の計算
- 正解単語数、置換/削除/挿入エラーの詳細、スコアに応じたメッセージフィードバック

---

## 4. Diff（差分）表示機能　★詳細実装仕様★

### 4.1 目的・特徴

- ユーザーの発話結果と教材テキストの違いを、直感的な色・装飾で表示
- 発音・読み上げ練習の評価結果を可視化し、改善点を明確化

### 4.2 前処理

- 小文字変換（lower）
- 前後空白削除（strip）
- フィラー語除去（um, uh, er, ah, mm, hmm, you know, like, actually, basically, so, well, okay, right）
- 句読点統一、連続空白の正規化、単語区切り統一

### 4.3 Diff生成アルゴリズム

- Python標準ライブラリ`difflib.SequenceMatcher`利用
- テキストを単語単位で分割し、差分操作コードを取得
- オペレーション（equal/replace/insert/delete）に応じたHTML生成
- **equal**: そのまま表示
- **replace**: `<span class="delete">元</span> <span class="insert">新</span>`
- **insert**: `<span class="insert">追加テキスト</span>`
- **delete**: `<span class="delete">削除テキスト</span>`

### 4.4 CSS表示スタイル

```css
.diff-result .insert {
    background-color: #ffe0e0;
    text-decoration: line-through;
    padding: 2px 4px;
    border-radius: 3px;
    display: inline;
    margin: 0 2px;
}
.diff-result .delete {
    /* 削除部分のスタイル */
    padding: 2px 4px;
    border-radius: 3px;
    display: inline;
    margin: 0 2px;
}
```

- 挿入部分: 薄赤背景＋取り消し線
- 削除部分: 標準表示（今後色変更も検討可）

### 4.5 表示モード

- **評価結果モード**（教材を基準にdiffを出す）
- **シャドウイング表示モード**（ユーザー発話基準も可能）
- `mode='user'`/`mode='original'`の2種表示切り替え（実装レベル）

### 4.6 HTML出力例

```html
<div class="diff-result">
    <span class="delete">削除されたテキスト</span>
    <span class="insert">挿入されたテキスト</span>
    正常なテキスト
</div>
```

### 4.7 利用シーン

- シャドウイング練習
- カスタム教材との比較
- 音読練習
- 任意のテキスト比較

### 4.8 エラーハンドリング

- 空文字チェック、文字数制限、エンコーディング検証
- Diff生成失敗時のフォールバック表示、HTMLエスケープ処理

### 4.9 パフォーマンス・拡張

- 最大テキスト長: 10,000文字、処理タイムアウト30秒
- 今後：音声波形同期・エラー詳細分析・多言語対応・スタイルカスタマイズ

---

## 5. データモデル

- 教材（Recording）：録音/ファイル両対応、ID/パス/日時/文字起こし結果
- 練習セッション（PracticeSession）：練習タイプ/テキスト/認識結果/スコア/エラー詳細/日時

---

## 6. その他

- エラーハンドリングや非同期処理はAppleガイドライン順守
- 今後：OpenAI API統合や学習カリキュラム化も視野

